<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Греческий Словарь</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; }
        .table-container { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.75rem; overflow: hidden; border: 1px solid #e2e8f0; background: white; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .data-table th { background-color: #f1f5f9; color: #475569; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; padding: 12px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        .data-table td { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        @media (max-width: 640px) {
            .col-hide-mobile { display: none; }
            .data-table th, .data-table td { padding: 10px 8px; font-size: 0.85rem; }
            .data-table { table-layout: fixed; }
        }
        .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; white-space: nowrap; }
        .badge-pos { background-color: #e0e7ff; color: #3730a3; }
        .badge-area { background-color: #dcfce7; color: #166534; }
        .highlight { background-color: #fef08a; border-radius: 2px; }
        .study-blur { filter: blur(6px); cursor: pointer; transition: filter 0.2s; }
        .study-blur:active { filter: blur(0); }
    </style>
</head>
<body class="h-screen flex flex-col p-2 md:p-6 overflow-hidden">
    <div class="flex justify-between items-center mb-4 gap-4 flex-shrink-0 px-2">
        <div class="flex items-center gap-3">
            <div class="h-10 w-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg"><i class="fa-solid fa-book"></i></div>
            <div>
                <h1 class="text-lg md:text-xl font-bold text-gray-800">Greek Dictionary</h1>
                <div class="text-[10px] text-gray-500 font-mono" id="statsDisplay">Загрузка базы...</div>
            </div>
        </div>
        <button id="btnStudyMode" class="btn border border-orange-200 bg-orange-50 text-orange-700 rounded-lg px-3 py-2 text-sm flex items-center">
            <i class="fa-solid fa-graduation-cap md:mr-2"></i> <span class="hidden md:inline">Тренировка</span>
        </button>
    </div>
    <div class="flex-grow flex flex-col min-h-0 table-container">
        <div class="p-3 border-b border-gray-100 flex items-center gap-2 bg-gray-50/50">
            <div class="relative flex-grow">
                <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-200 rounded-xl outline-none focus:border-blue-500 shadow-sm" placeholder="Поиск по словам...">
            </div>
            <div id="searchCount" class="text-xs text-gray-400 font-medium whitespace-nowrap px-2"></div>
        </div>
        <div class="flex-grow overflow-auto" id="tableScrollArea">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="w-[45%] md:w-[25%]">Греческий</th>
                        <th class="w-[55%] md:w-[35%]">Русский</th>
                        <th class="col-hide-mobile w-[15%]">Ч.Речи</th>
                        <th class="col-hide-mobile w-[15%]">Область</th>
                        <th class="col-hide-mobile w-[10%]">Дата</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="scrollSentinel" class="h-10 w-full flex items-center justify-center">
                <i class="fa-solid fa-spinner fa-spin hidden text-blue-500" id="loadingSpinner"></i>
            </div>
        </div>
    </div>

    <script>
        let DATABASE_CONTENT = [];
        let filteredData = [];
        let renderedCount = 0;
        const RENDER_CHUNK = 50;
        let studyMode = false;
        const el = id => document.getElementById(id);

        async function loadExternalData() {
            try {
                const response = await fetch('data.json?v=' + Date.now()); // Добавили v= для обхода кэша
                if (!response.ok) throw new Error('Файл data.json не найден');
                DATABASE_CONTENT = await response.json();
                
                // Сортировка по дате (свежие сверху)
                DATABASE_CONTENT.sort((a, b) => new Date(b.column_F_date) - new Date(a.column_F_date));
                
                updateDisplay(true);
            } catch (err) {
                console.error(err);
                el('statsDisplay').textContent = "Ошибка загрузки данных";
            }
        }

        function updateDisplay(reset = true) {
            const q = el('searchInput').value.toLowerCase().trim();
            filteredData = DATABASE_CONTENT.filter(item => {
                const gStr = (item.column_A_greek || []).join(' ').toLowerCase();
                const rStr = (item.column_B_russian || []).join(' ').toLowerCase();
                return !q || gStr.includes(q) || rStr.includes(q);
            });
            el('statsDisplay').textContent = `Записей: ${DATABASE_CONTENT.length}`;
            el('searchCount').textContent = `${filteredData.length} найдено`;
            if (reset) {
                el('tableBody').innerHTML = '';
                renderedCount = 0;
                renderMore();
            }
        }

        function renderMore() {
            const tbody = el('tableBody');
            const q = el('searchInput').value.toLowerCase().trim();
            const limit = Math.min(filteredData.length, renderedCount + RENDER_CHUNK);
            const chunk = filteredData.slice(renderedCount, limit);

            chunk.forEach(item => {
                const tr = document.createElement('tr');
                const highlight = (txt) => {
                    if (!q) return txt;
                    const regex = new RegExp(`(${q})`, 'gi');
                    return String(txt).replace(regex, '<span class="highlight">$1</span>');
                };
                tr.innerHTML = `
                    <td class="font-semibold text-blue-900">${item.column_A_greek.map(highlight).join(', ')}</td>
                    <td class="text-gray-700 ${studyMode ? 'study-blur' : ''}">${item.column_B_russian.map(highlight).join(', ')}</td>
                    <td class="col-hide-mobile"><span class="badge badge-pos">${item.column_D_part_of_speech}</span></td>
                    <td class="col-hide-mobile"><span class="badge badge-area">${item.column_E_area}</span></td>
                    <td class="col-hide-mobile text-[10px] font-mono text-gray-400">${item.column_F_date}</td>
                `;
                tbody.appendChild(tr);
            });
            renderedCount = limit;
            el('loadingSpinner').classList.toggle('hidden', renderedCount >= filteredData.length);
        }

        function toggleStudyMode() {
            studyMode = !studyMode;
            el('btnStudyMode').classList.toggle('bg-orange-600', studyMode);
            el('btnStudyMode').classList.toggle('text-white', studyMode);
            updateDisplay(true);
        }

        window.onload = () => {
            el('searchInput').oninput = () => updateDisplay(true);
            el('btnStudyMode').onclick = toggleStudyMode;
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && renderedCount < filteredData.length) renderMore();
            }, { root: el('tableScrollArea'), threshold: 0.1 });
            observer.observe(el('scrollSentinel'));
            loadExternalData();
        };
    </script>
</body>
</html>
